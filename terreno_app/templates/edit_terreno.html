{% extends 'base.html' %}
{% load static %}

{% block content %}
<main>
    <div class="auth-card">
        <h2 class="sub-title">✏️ Editar Terreno: {{ terreno.nome }}</h2>
        <p>Use o formulário abaixo para atualizar os dados do seu terreno, incluindo a localização.</p>

        {% if messages %}
            {% for message in messages %}
                <div class="message-{{ message.tags }}" style="padding: 10px; margin-bottom: 15px; border-radius: 6px; background-color: #e0f2f1; color: #0f766e;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post">
            {% csrf_token %}
            {% for field in form %}
                {% if field.name == 'pais' %}
                    <div class="form-field">
                        <label for="{{ field.id_for_label }}">País:</label>
                        {{ field }}
                        {% if field.errors %}<ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">{% for error in field.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                    </div>

                {% elif field.name == 'estado' %}
                    <div class="form-field">
                        <label for="id_edit_estado">Estado:</label>
                        <select id="id_edit_estado" name="estado" class="form-control">
                            <option value="">Carregando estados...</option>
                        </select>
                        {% if field.errors %}<ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">{% for error in field.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                    </div>

                {% elif field.name == 'cidade' %}
                    <div class="form-field">
                        <label for="id_edit_cidade">Cidade:</label>
                        <select id="id_edit_cidade" name="cidade" class="form-control">
                            <option value="">Selecione um estado primeiro</option>
                        </select>
                        {% if field.errors %}<ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">{% for error in field.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                    </div>

                {% else %}
                    <div class="form-field">
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                        {{ field }}
                        {% if field.errors %}<ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">{% for error in field.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                    </div>
                {% endif %}
            {% endfor %}
            <button type="submit">Salvar Alterações</button>
        </form>

        <p style="margin-top: 20px; text-align: center;">
            <a href="{% url 'agro_app:dashboard' %}" class="back-link" style="color: #2196F3; font-weight: bold;">← Voltar para a Dashboard</a>
        </p>
    </div>
</main>

<input type="hidden" id="get-states-url-edit" value="{% url 'agro_app:get_states' %}">
<input type="hidden" id="get-cities-url-edit" value="{% url 'agro_app:get_cities' 0 %}">


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos do formulário de EDIÇÃO DE TERRENO
        const countrySelect = document.getElementById('id_pais'); // O ID gerado pelo ModelForm para 'pais'
        const stateSelect = document.getElementById('id_edit_estado');
        const citySelect = document.getElementById('id_edit_cidade');

        // Obtém URLs das APIs do IBGE
        const getStatesUrl = document.getElementById('get-states-url-edit').value;
        const getCitiesUrlBase = document.getElementById('get-cities-url-edit').value.slice(0, -1);

        // Valores iniciais do Terreno para pré-seleção
        const initial_country = '{{ terreno.pais|default:"" }}';
        const initial_state_id = '{{ terreno.estado|default:"" }}';
        const initial_city_id = '{{ terreno.cidade|default:"" }}';

        // Preenche o campo de estado
        function loadStates() {
            fetch(getStatesUrl)
                .then(response => response.json())
                .then(states => {
                    let optionsHtml = '<option value="">Selecione um estado</option>';
                    states.sort((a, b) => a.nome.localeCompare(b.nome));
                    states.forEach(state => {
                        optionsHtml += `<option value="${state.id}">${state.nome}</option>`;
                    });
                    stateSelect.innerHTML = optionsHtml;

                    // 1. Pré-seleciona o estado atual, se existir
                    stateSelect.value = initial_state_id;

                    // 2. Se houver estado e cidade salvos, carrega as cidades
                    if (initial_state_id && initial_city_id) {
                        loadCities(initial_state_id, initial_city_id);
                    }
                })
                .catch(error => console.error('Erro ao carregar estados:', error));
        }

        // Preenche o campo de cidade
        function loadCities(stateId, cityId = null) {
            citySelect.innerHTML = '<option value="">Carregando cidades...</option>'; // Loading

            fetch(`${getCitiesUrlBase}${stateId}/`)
                .then(response => response.json())
                .then(cities => {
                    let optionsHtml = '<option value="">Selecione uma cidade</option>';
                    cities.sort((a, b) => a.nome.localeCompare(b.nome));
                    cities.forEach(city => {
                        optionsHtml += `<option value="${city.id}">${city.nome}</option>`;
                    });
                    citySelect.innerHTML = optionsHtml;

                    // 3. Pré-seleciona a cidade atual, se existir
                    if (cityId) {
                        citySelect.value = cityId;
                    } else {
                        citySelect.value = '';
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar cidades:', error);
                    citySelect.innerHTML = '<option value="">Erro ao carregar cidades</option>';
                });
        }

        // Event listener para o campo de País
        if (countrySelect) {
            // Se o País for Brasil na inicialização, carrega os estados
            if (initial_country === 'Brasil') {
                loadStates();
            } else {
                stateSelect.innerHTML = '<option value="">Selecione um país primeiro</option>';
                citySelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
            }

            countrySelect.addEventListener('change', function() {
                if (this.value === 'Brasil') {
                    loadStates();
                } else {
                    // Limpa os dropdowns se o país não for Brasil
                    stateSelect.innerHTML = '<option value="">Selecione um país primeiro</option>';
                    citySelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
                }
            });
        }


        // Event listener para o campo de estado
        stateSelect.addEventListener('change', function() {
            const selectedStateId = this.value;
            if (selectedStateId) {
                // Carrega cidades, sem pré-selecionar nenhuma (pois o estado mudou)
                loadCities(selectedStateId);
            } else {
                citySelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
            }
        });
    });
</script>
{% endblock %}