{% extends 'base.html' %}
{% load static %}

{% block content %}
<main>
    <div class="auth-card">
        <h2 class="sub-title">✏️ Editar Terreno: {{ terreno.name }}</h2>
        <p>Use o formulário abaixo para atualizar os dados do seu terreno, incluindo a localização.</p>

        <!-- Tratamento de Mensagens -->
        {% if messages %}
            {% for message in messages %}
                <div class="message-{{ message.tags }}" style="padding: 10px; margin-bottom: 15px; border-radius: 6px; background-color: #e0f2f1; color: #0f766e;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- O formulário POSTa para a mesma URL que o chamou, usando o PK do terreno -->
        <form method="post">
            {% csrf_token %}
            {% for field in form %}
                <!-- Renderiza os campos de localização como selects separados, conforme a estrutura do Profile -->
                {% if field.name == 'state' %}
                    <div class="form-field">
                        <label for="{{ field.id_for_label }}">Estado:</label>
                        <select id="{{ field.id_for_label }}" name="{{ field.name }}" class="form-control">
                            <option value="">Carregando estados...</option>
                        </select>
                        {% if field.errors %}<ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">{% for error in field.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                    </div>
                {% elif field.name == 'city' %}
                    <div class="form-field">
                        <label for="{{ field.id_for_label }}">Cidade:</label>
                        <select id="{{ field.id_for_label }}" name="{{ field.name }}" class="form-control">
                            <option value="">Selecione um estado primeiro</option>
                        </select>
                        {% if field.errors %}<ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">{% for error in field.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                    </div>
                {% else %}
                    <div class="form-field">
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                        {{ field }}
                        {% if field.errors %}<ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">{% for error in field.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                    </div>
                {% endif %}
            {% endfor %}
            <button type="submit">Salvar Alterações</button>
        </form>

        <p style="margin-top: 20px; text-align: center;">
            <a href="{% url 'agro_app:dashboard' %}" class="back-link" style="color: #2196F3; font-weight: bold;">← Voltar para a Dashboard</a>
        </p>
    </div>
</main>

<!-- Campos escondidos para obter as URLs de API necessárias (do agro_app) -->
<input type="hidden" id="get-states-url" value="{% url 'agro_app:get_states' %}">
<!-- O '0' é um placeholder que será substituído pelo JS -->
<input type="hidden" id="get-cities-url" value="{% url 'agro_app:get_cities' 0 %}">


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const stateSelect = document.getElementById('id_state');
        const citySelect = document.getElementById('id_city');
        // Obtém URLs das APIs do IBGE
        const getStatesUrl = document.getElementById('get-states-url').value;
        const getCitiesUrlBase = document.getElementById('get-cities-url').value.slice(0, -1);

        // Valores iniciais do Terreno para pré-seleção
        const initial_state_id = '{{ terreno.state|default:"" }}';
        const initial_city_id = '{{ terreno.city|default:"" }}';

        // Preenche o campo de estado
        function loadStates() {
            fetch(getStatesUrl)
                .then(response => response.json())
                .then(states => {
                    let optionsHtml = '<option value="">Selecione um estado</option>';
                    states.sort((a, b) => a.nome.localeCompare(b.nome));
                    states.forEach(state => {
                        optionsHtml += `<option value="${state.id}">${state.nome}</option>`;
                    });
                    stateSelect.innerHTML = optionsHtml;

                    // Pré-seleciona o estado atual, se existir
                    stateSelect.value = initial_state_id;

                    // Se houver estado e cidade salvos, carrega as cidades
                    if (initial_state_id && initial_city_id) {
                        loadCities(initial_state_id, initial_city_id);
                    }
                })
                .catch(error => console.error('Erro ao carregar estados:', error));
        }

        // Preenche o campo de cidade
        function loadCities(stateId, cityId = null) {
            citySelect.innerHTML = '<option value="">Carregando cidades...</option>'; // Loading

            fetch(`${getCitiesUrlBase}${stateId}/`)
                .then(response => response.json())
                .then(cities => {
                    let optionsHtml = '<option value="">Selecione uma cidade</option>';
                    cities.sort((a, b) => a.nome.localeCompare(b.nome));
                    cities.forEach(city => {
                        optionsHtml += `<option value="${city.id}">${city.nome}</option>`;
                    });
                    citySelect.innerHTML = optionsHtml;

                    // Pré-seleciona a cidade atual, se existir
                    if (cityId) {
                        citySelect.value = cityId;
                    } else {
                        citySelect.value = '';
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar cidades:', error);
                    citySelect.innerHTML = '<option value="">Erro ao carregar cidades</option>';
                });
        }

        // Event listener para o campo de estado
        stateSelect.addEventListener('change', function() {
            const selectedStateId = this.value;
            if (selectedStateId) {
                // Carrega cidades, sem pré-selecionar nenhuma (pois o estado mudou)
                loadCities(selectedStateId);
            } else {
                citySelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
            }
        });

        // Inicia o carregamento dos estados quando a página carregar
        loadStates();
    });
</script>
{% endblock %}
