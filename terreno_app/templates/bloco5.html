{# inicio card7 - Gerenciamento de Terrenos #}
<div class="dash-card dash-card-responsive-half">
    <h4>üå± Gerenciamento de Terrenos</h4>
    <p>Cadastre e acompanhe os seus terrenos e o cultivo principal em cada um.</p>

    <div class="terreno-form-container" id="terreno-create-form">
        <h5>Cadastrar Novo Terreno</h5>
        <form method="post" action="{% url 'terreno_app:create_terreno' %}" id="create-terreno-form">
            {% csrf_token %}
            {% for field in terreno_form %}
                {# Renderiza nome, √°rea, e unidade de medida #}
                {% if field.name == 'nome' or field.name == 'area_total' or field.name == 'unidade_area' %}
                    <p>
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                        {{ field }}
                        {% if field.errors %}
                            <ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">
                                {% for error in field.errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        {% endif %}
                    </p>
                {% endif %}
            {% endfor %}

            <p>
                <label for="{{ terreno_form.pais.id_for_label }}">{{ terreno_form.pais.label }}:</label>
                {{ terreno_form.pais }}
            </p>

            <p>
                <label for="id_terreno_estado">Estado:</label>
                <select id="id_terreno_estado" name="estado" class="form-control">
                    <option value="">Selecione um pa√≠s primeiro</option>
                </select>
                {% if terreno_form.estado.errors %}
                    <ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">
                        {% for error in terreno_form.estado.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </p>

            <p>
                <label for="id_terreno_cidade">Cidade:</label>
                <select id="id_terreno_cidade" name="cidade" class="form-control">
                    <option value="">Selecione um estado primeiro</option>
                </select>
                {% if terreno_form.cidade.errors %}
                    <ul style="color: red; list-style: none; padding: 0; font-size: 0.9em;">
                        {% for error in terreno_form.cidade.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </p>


            <button type="submit" class="edit-btn" style="width: 100%; margin-top: 10px;">Salvar Terreno</button>
        </form>
    </div>

    <h5 style="margin-top: 30px; border-bottom: 1px solid #eee; padding-bottom: 5px;">Seus Terrenos Atuais ({{ terrenos|length }})</h5>

    {% if terrenos %}
        <ul class="terreno-list">
            {% for terreno in terrenos %}
                <li class="terreno-item">
                    <div class="terreno-details">
                        <strong>{{ terreno.nome }}</strong>
                        {# CORRE√á√ÉO: Usando 'area_total' e 'unidade_area' (nomes reais do modelo) #}
                        <small>
                            | √Årea: **{{ terreno.area_total|default:"0"|floatformat:"2" }} {{ terreno.unidade_area }}**
                            {# CORRE√á√ÉO CR√çTICA: Agora usa o campo 'localizacao_display' traduzido da View #}
                            | Localiza√ß√£o: **{{ terreno.localizacao_display }}**
                            | Cultivo: **{{ terreno.cultivo_display }}**
                        </small>
                    </div>
                    <div class="terreno-actions">
                        <a href="{% url 'terreno_app:edit_terreno' pk=terreno.pk %}" class="edit-btn">
                            Editar
                        </a>
                        <form method="post" action="{% url 'terreno_app:delete_terreno' pk=terreno.pk %}" style="display:inline;" onsubmit="return confirmDelete(event, '{{ terreno.nome|escapejs }}')">
                            {% csrf_token %}
                            <button type="submit" class="delete-btn">Excluir</button>
                        </form>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p style="margin-top: 10px;">Voc√™ ainda n√£o tem terrenos cadastrados. Use o formul√°rio acima para adicionar o seu primeiro.</p>
    {% endif %}

    <input type="hidden" id="get-states-url-terreno" value="{% url 'agro_app:get_states' %}">
    <input type="hidden" id="get-cities-url-terreno" value="{% url 'agro_app:get_cities' 0 %}">


    <script>
        // Fun√ß√£o para exibir um modal de confirma√ß√£o simples
        function confirmDelete(event, itemName) {
            // ATEN√á√ÉO: Substitu√≠do window.confirm por um simples prompt, pois alerts/confirms podem ser bloqueados em iframes.
            const confirmed = prompt(`Tem certeza que deseja excluir o terreno '${itemName}'? Digite SIM para confirmar.`) === 'SIM';
            if (!confirmed) {
                event.preventDefault();
            }
            return confirmed;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do formul√°rio de CRIA√á√ÉO DE TERRENO (bloco5)
            const countrySelect = document.getElementById('id_pais'); // O ID gerado pelo ModelForm para 'pais'
            const stateSelect = document.getElementById('id_terreno_estado'); // ID customizado
            const citySelect = document.getElementById('id_terreno_cidade'); // ID customizado

            // Obt√©m URLs das APIs do IBGE (armazenadas em campos hidden acima)
            const getStatesUrl = document.getElementById('get-states-url-terreno').value;
            const getCitiesUrlBase = document.getElementById('get-cities-url-terreno').value.slice(0, -1);


            // Preenche o campo de estado
            function loadStates() {
                stateSelect.innerHTML = '<option value="">Carregando estados...</option>';
                citySelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';

                fetch(getStatesUrl)
                    .then(response => response.json())
                    .then(states => {
                        let optionsHtml = '<option value="">Selecione um estado</option>';
                        states.sort((a, b) => a.nome.localeCompare(b.nome));
                        states.forEach(state => {
                            optionsHtml += `<option value="${state.id}">${state.nome}</option>`;
                        });
                        stateSelect.innerHTML = optionsHtml;
                    })
                    .catch(error => {
                        console.error('Erro ao carregar estados:', error);
                        stateSelect.innerHTML = '<option value="">Erro ao carregar estados</option>';
                    });
            }

            // Preenche o campo de cidade
            function loadCities(stateId) {
                citySelect.innerHTML = '<option value="">Carregando cidades...</option>';

                fetch(`${getCitiesUrlBase}${stateId}/`)
                    .then(response => response.json())
                    .then(cities => {
                        let optionsHtml = '<option value="">Selecione uma cidade</option>';
                        cities.sort((a, b) => a.nome.localeCompare(b.nome));
                        cities.forEach(city => {
                            optionsHtml += `<option value="${city.id}">${city.nome}</option>`;
                        });
                        citySelect.innerHTML = optionsHtml;
                    })
                    .catch(error => {
                        console.error('Erro ao carregar cidades:', error);
                        citySelect.innerHTML = '<option value="">Erro ao carregar cidades</option>';
                    });
            }

            // A√ß√£o de Pa√≠s
            if (countrySelect) {
                // Inicializa com base no valor padr√£o (se for 'Brasil')
                if (countrySelect.value === '1058' || countrySelect.value === 'Brasil') {
                    loadStates();
                }

                countrySelect.addEventListener('change', function() {
                    // Assumindo que '1058' √© o ID do Brasil, se vier da API de pa√≠ses ou do banco
                    if (this.value === '1058' || this.value === 'Brasil') {
                        loadStates();
                    } else {
                        // Limpa os dropdowns se o pa√≠s n√£o for Brasil
                        stateSelect.innerHTML = '<option value="">Selecione um pa√≠s primeiro</option>';
                        citySelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
                    }
                });
            }

            // A√ß√£o de Estado
            if (stateSelect) {
                stateSelect.addEventListener('change', function() {
                    const selectedStateId = this.value;
                    if (selectedStateId) {
                        loadCities(selectedStateId);
                    } else {
                        citySelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
                    }
                });
            }
        });
    </script>
</div>
{# fim card7 #}
