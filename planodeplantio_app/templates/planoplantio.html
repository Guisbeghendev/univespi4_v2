{% extends "base.html" %}
{% load static %}

{% block title %}AgroData - Configurar Plano de Plantio{% endblock %}

{% block content %}
    <div class="dash-card page-container">
        <h1 class="main-title">Configurar Plano de Plantio</h1>
        <h2 class="sub-title">Etapa 1: Seleção do Cultivo</h2>

        <div class="terreno-info-box-status">
            <p>Plano ID: <strong>{{ plano.pk }}</strong></p>
            <p>Terreno: <strong>{{ terreno.nome }}</strong></p>
            <p>Local: <strong>{{ localizacao_display }}</strong></p>
            <p>Status: <strong>{{ plano.status }}</strong></p>
        </div>

        <div class="plan-wizard-grid">
            <div class="dash-card">
                <h3>Selecione o Cultivo para o Terreno</h3>
                <form id="etapa1Form">
                    {% csrf_token %}

                    <input type="hidden" id="planoId" value="{{ plano.pk }}">
                    <input type="hidden" id="cidadeIbgeId" value="{{ cidade_ibge_id }}">

                    <div class="form-field">
                        <label for="produtoSelect">Produtos Disponíveis na Região:</label>
                        <select id="produtoSelect" name="produto_nome" required
                            class="form-field-input">
                            <option value="" disabled selected>Escolha um produto...</option>
                            {% for produto in produtos_disponiveis %}
                                <option value="{{ produto.nome }}">{{ produto.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <p class="small-text-padrao">
                        Selecione o produto desejado e visualize a ficha técnica ao lado.
                    </p>
                    <button type="submit" id="salvarEtapa1Btn" class="plan-action-btn-main action-btn-with-spinner" disabled>
                        <span id="btnEtapa1Text">Confirmar Seleção de Cultivo</span>
                        <span id="loadingSpinnerEtapa1" class="hidden spinner spinner-small"></span>
                    </button>
                    <p id="messageBoxEtapa1" class="text-center-mt3"></p>
                </form>
            </div>

            <div class="dash-card">
                <h3>Ficha Técnica para Análise</h3>
                <div id="plan-preview-display">
                    <p class="text-center-padrao">
                        Selecione um produto ao lado para carregar sua ficha técnica e auxiliar na decisão.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variáveis de URL (Definidas no template Django)
        const API_FICHA_BUSCAR_URL = "{% url 'plano:api_buscar_ficha' %}";
        const API_SALVAR_ETAPA1_URL = "{% url 'plano:api_salvar_etapa1' plano_id=plano.pk %}";

        // A próxima URL de redirecionamento (planofinal.html ou fallback)
        // O log de submissão do formulário acima está usando FALLBACK_URL,
        // mas a API retorna 'next_url' que redireciona para 'plano:planofinal_plano'
        // Vamos manter o FALLBACK_URL para evitar erros no JS:
        const FALLBACK_URL = "{% url 'agro_app:dashboard' %}";


        // ======================================================================
        // CÓDIGO JAVASCRIPT: planoplantio.js (INCLUSO DIRETAMENTE)
        // ======================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Referências do DOM
            const produtoSelect = document.getElementById('produtoSelect');
            const cidadeIbgeId = document.getElementById('cidadeIbgeId').value;
            // const planId = document.getElementById('planoId').value; // Não usado no JS, mas mantido no HTML

            const previewDisplay = document.getElementById('plan-preview-display');
            const salvarBtn = document.getElementById('salvarEtapa1Btn');
            const etapa1Form = document.getElementById('etapa1Form');

            const btnText = document.getElementById('btnEtapa1Text');
            const loadingSpinner = document.getElementById('loadingSpinnerEtapa1');
            const messageBox = document.getElementById('messageBoxEtapa1');

            // Funções Utilitárias

            /**
             * Alterna o estado de loading no botão.
             * @param {boolean} isLoading
             */
            const toggleLoading = (isLoading) => {
                salvarBtn.disabled = isLoading;
                if (isLoading) {
                    btnText.textContent = 'Salvando...';
                    loadingSpinner.classList.remove('hidden');
                } else {
                    btnText.textContent = 'Confirmar Seleção de Cultivo';
                    loadingSpinner.classList.add('hidden');
                }
            };

            /**
             * Renderiza o HTML da Ficha Técnica na área de preview.
             * Reutiliza as classes CSS do main.css (ficha-detail-section, ficha-detail-grid, etc.)
             * @param {object} fichaData - Os dados da ficha técnica.
             */
            const renderFichaTecnica = (fichaData) => {
                if (!fichaData || Object.keys(fichaData).length === 0) {
                    previewDisplay.innerHTML = '<p class="text-center text-red-500">Ficha Técnica não disponível para este produto/local.</p>';
                    salvarBtn.disabled = true;
                    return;
                }

                let html = '';

                for (const sectionTitle in fichaData) {
                    if (fichaData.hasOwnProperty(sectionTitle)) {
                        const sectionData = fichaData[sectionTitle];

                        // Abre a seção
                        html += `
                            <section class="ficha-detail-section">
                                <h4 class="ficha-detail-title">${sectionTitle}</h4>
                                <dl class="ficha-detail-grid">
                        `;

                        // Adiciona os itens (dt e dd)
                        for (const detailName in sectionData) {
                            if (sectionData.hasOwnProperty(detailName)) {
                                const detailValue = sectionData[detailName];
                                html += `
                                    <div class="ficha-detail-item">
                                        <dt>${detailName}</dt>
                                        <dd>${detailValue}</dd>
                                    </div>
                                `;
                            }
                        }

                        // Fecha a seção
                        html += `</dl></section>`;
                    }
                }

                previewDisplay.innerHTML = html;
                // Habilita o botão *somente* se a ficha foi carregada com sucesso
                salvarBtn.disabled = false;
            };


            // Lógica principal: Carregamento da Ficha

            produtoSelect.addEventListener('change', async () => {
                const produtoNome = produtoSelect.value;
                if (!produtoNome) {
                    previewDisplay.innerHTML = '<p class="text-center text-gray-500">Selecione um produto ao lado para carregar sua ficha técnica e auxiliar na decisão.</p>';
                    salvarBtn.disabled = true;
                    return;
                }

                // Limpa a messageBox e exibe o spinner
                messageBox.textContent = '';
                previewDisplay.innerHTML = `<div class="spinner mx-auto my-4"></div><p class="text-center text-gray-500">Carregando ficha técnica de ${produtoNome}...</p>`;
                salvarBtn.disabled = true; // Desabilita o botão enquanto carrega

                try {
                    const url = `${API_FICHA_BUSCAR_URL}?produto_nome=${encodeURIComponent(produtoNome)}&cidade_id=${cidadeIbgeId}`;

                    const response = await fetch(url);

                    if (!response.ok) {
                        const errorData = await response.json();
                        renderFichaTecnica(null);
                        messageBox.textContent = `Erro: ${errorData.error || 'Não foi possível carregar os dados.'}`;
                        return;
                    }

                    const fichaData = await response.json();
                    renderFichaTecnica(fichaData);

                } catch (error) {
                    console.error('Erro ao buscar ficha técnica:', error);
                    renderFichaTecnica(null);
                    messageBox.textContent = 'Erro de conexão ou falha ao processar os dados.';
                }
            });

            // Lógica de Submissão do Formulário (Salvar Etapa 1)

            etapa1Form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const produtoNome = produtoSelect.value;

                if (!produtoNome) {
                    messageBox.textContent = 'Por favor, selecione um produto antes de salvar.';
                    messageBox.style.color = '#dc3545'; // Vermelho de erro
                    return;
                }

                messageBox.textContent = '';
                toggleLoading(true);

                const payload = {
                    produto_nome: produtoNome,
                    // Enviando Datas como null/vazio, conforme a regra de negócio atual
                    data_inicio: null,
                    data_colheita_prevista: null,
                };

                try {
                    // A API_SALVAR_ETAPA1_URL já contém o plano.pk
                    const response = await fetch(API_SALVAR_ETAPA1_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // Obtém o CSRF Token do input oculto no formulário
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        messageBox.textContent = result.message || 'Cultivo salvo com sucesso! Redirecionando...';
                        messageBox.style.color = '#2e7d32'; // Verde de sucesso

                        // Redireciona para o próximo passo (URL retornada pela API)
                        // A API retorna 'next_url' que deve levar para 'plano:planofinal_plano'
                        setTimeout(() => {
                            window.location.href = result.next_url || FALLBACK_URL;
                        }, 1500);

                    } else {
                        messageBox.textContent = `Erro ao salvar: ${result.error || 'Falha de comunicação.'}`;
                        messageBox.style.color = '#dc3545'; // Vermelho de erro
                    }

                } catch (error) {
                    console.error('Erro de submissão:', error);
                    messageBox.textContent = 'Erro de rede ou falha interna ao salvar.';
                    messageBox.style.color = '#dc3545'; // Vermelho de erro
                } finally {
                    toggleLoading(false);
                }
            });
        });
    </script>
{% endblock %}